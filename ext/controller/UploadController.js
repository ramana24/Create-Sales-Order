/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Fragment","sap/m/MessageBox","sap/m/MessageToast","sap/ui/unified/FileUploader","sap/ui/model/json/JSONModel","sap/fe/macros/DelegateUtil"],function(F,M,a,b,J,D){"use strict";var t={oNewRequestContext:null,sCurrentCompanyCode:null,onPressUploadFile:function(e){var E=this;var r=this.getModel("i18n").getResourceBundle();var d=t.getObjectById("uploadReportRawDataDialog","dialogUploadFile");var u=Promise.resolve(d);if(!d){u=E.loadFragment({id:"uploadReportRawDataDialog",name:"cus.sd.so.create.auto.xtrctns1.ext.Fragments.FileUploadDialog",controller:t.createController(E,r)});u.then(function(d){E.addDependent(d);var f=t.getObjectById("uploadReportRawDataDialog","fileUploaderRawData");f.addStyleClass("sapUiNoMarginBegin");var i="$";var B={};if(i.length===2){B={$updateGroupId:"noSubmit",$groupId:"noSubmit"};}else{B={$$updateGroupId:"noSubmit",$$groupId:"noSubmit"};}var T=E.getModel().bindList('/SalesOrderRequest',null,[],[],B);var o=T.create({});var c=t.getObjectById("uploadReportRawDataDialog","CompanyCodeInput");c.setBindingContext(o);});}u.then(function(d){d.open();t.autoFillCompanyCode();});},autoFillCompanyCode:function(){var c=t.getObjectById("uploadReportRawDataDialog","CompanyCodeInput");var C=c.getBindingContext();if(t.sCurrentCompanyCode){C.setProperty("CompanyCode",t.sCurrentCompanyCode);}},getObjectById:function(f,e){return sap.ui.core.Fragment.byId(f,e);},getContentType:function(f){var d=f.slice(f.lastIndexOf(".")+1);switch(d){case"jpeg":case"jpg":return"image/jpeg";case"tiff":case"tif":return"image/tiff";case"png":return"image/png";case"pdf":return"application/pdf";default:return"";}},setCurrentCompanyCode:function(c){t.sCurrentCompanyCode=c;},createController:function(e,r){return{onTypeMissMatch:function(E){M.error(r.getText("fileUpldVw_fileTypeMissMatch"));},onfileSizeExceed:function(E){M.error(r.getText("fileUpldVw_fileSizeExceed"));},onFilePathChange:function(E){var f=t.getObjectById("uploadReportRawDataDialog","fileUploaderRawData");var c=t.getObjectById("uploadReportRawDataDialog","CompanyCodeInput");var d=f.getFocusDomRef().files;var C=this.trimStr(c.getValue());var o=t.getObjectById("uploadReportRawDataDialog","rawReportUploadButton");if(!d||d.length!==1||!C){o.setEnabled(false);}else{o.setEnabled(true);}},onCompanyCodeChange:function(E){var f=t.getObjectById("uploadReportRawDataDialog","fileUploaderRawData");var c=t.getObjectById("uploadReportRawDataDialog","CompanyCodeInput");var d=f.getFocusDomRef().files;var C,R,s;s=c.getValue();var o=c.getBindingContext();var B=o.getObject();if(s){if(B.CompanyCodeName){C=B.CompanyCodeName+" ("+B.CompanyCode+")";}else{C=s;}}else{C=null;}var g=c.getDomRef();var i=g.getElementsByTagName("input");if(i.length===1&&i[0].value){R=i[0].value;}var h=t.getObjectById("uploadReportRawDataDialog","rawReportUploadButton");if(!d||d.length!==1||((R!==C)&&(R!==s))){h.setEnabled(false);}else{h.setEnabled(true);}},uploadFile:function(c){var f=t.getObjectById("uploadReportRawDataDialog","fileUploaderRawData");var C=t.getObjectById("uploadReportRawDataDialog","CompanyCodeInput");var s=this.trimStr(C.getValue());var d=f.getFocusDomRef().files;var g=f.getFocusDomRef().files[0].name;var h=new RegExp(/[^\u0020-\u00ff]/);var j=h.test(g);if(j){var k="";for(var i=0;i<g.length;i++){var l=h.test(g.charAt(i));if(l){k=k+g.charAt(i);}}M.error(r.getText("FilenameError",k));return;}else{if(!s){M.error(r.getText("fileUpldVw_invalidCompanyCode"));return;}if(!d||d.length!==1){M.error(r.getText("fileUpldVw_invalidPdf"));return;}t.setCurrentCompanyCode(s);var o=t.getObjectById("uploadReportRawDataDialog","dialogUploadFile");o.setBusy(true);var A="com.sap.gateway.srvd.c_slsordreqfrmextsource_sd.v0001.CreateSalesOrderRequest";var m=e.getModel(),L=m.bindList("/SalesOrderRequest"),n=L.getHeaderContext(),p=m.bindContext(A+"(...)",n);p.setParameter("ResultIsActiveEntity",true);p.setParameter("SalesOrderRequestCategory","A");p.setParameter("CompanyCode",s);p.execute().then(this.onCreateSORComplete,this.onCreateSORFailed);}},onUploadComplete:function(E){var d=t.getObjectById("uploadReportRawDataDialog","dialogUploadFile");var f=E.getSource();f.removeAllHeaderParameters();var s=E.getParameter("status")+"";if(s[0]==='2'){d.setBusy(false);f.removeAllHeaderParameters();f.clear();var c=t.getObjectById("uploadReportRawDataDialog","CompanyCodeInput");var C=c.getBindingContext();C.setProperty("CompanyCode","");C.setProperty("CompanyCodeName","");d.close();e.refresh();var S=t.oNewRequestContext.getObject().SalesOrderRequest;if(E.getParameter("headers")["sap-messages"]){try{var m=JSON.parse(E.getParameter("headers")["sap-messages"]);var l=t.oNewRequestContext.getObject("SalesOrderRequestLogHandle");var g=m[0].message;M.error(g);var h=t.oNewRequestContext.getModel().mMessages;if(h instanceof Array){t.oNewRequestContext.getModel().mMessages.push({"logHanlde":l,"Message":g});}else{t.oNewRequestContext.getModel().mMessages=[{"logHanlde":l,"Message":g}];}}catch(i){M.error(r.getText("fileUpldBiz_uploadFailed"));}}else{a.show(r.getText("fileUpldBiz_uploaded",S));}}else{t.oNewRequestContext.delete("$auto").then(this.onUploadFailed,this.onUploadFailed);}},onUploadCancel:function(E){var f=t.getObjectById("uploadReportRawDataDialog","fileUploaderRawData");f.removeAllHeaderParameters();f.clear();var c=t.getObjectById("uploadReportRawDataDialog","CompanyCodeInput");var C=c.getBindingContext();C.setProperty("CompanyCode","");C.setProperty("CompanyCodeName","");var i=c.getContent().getContentEdit()[0].getAggregation("_content")[0];if(i.getValueState()==='Error'&&i.getValue()){i.setValue('');}var o=t.getObjectById("uploadReportRawDataDialog","rawReportUploadButton");o.setEnabled(false);var d=E.getSource().getParent();d.close();},handleImportError:function(E,m){var s=r.getText(m?m:"fileUpldBiz_uploadFailed");if(typeof E.error==="object"){M.error(E.error.message?E.error.message:s);}else{try{var o=JSON.parse(E.responseText);}catch(c){M.error(s);return;}M.error(o.error&&o.error.message&&o.error.message.value?o.error.message.value:s);}},onCreateSORComplete:function(c){t.oNewRequestContext=c;var n=t.oNewRequestContext.getObject();var f="/sap/opu/odata4/sap/c_slsordreqfrmextsrc_srv/srvd/sap/c_slsordreqfrmextsource_sd/0001/SalesOrderRequest(SalesOrderRequest='"+n.SalesOrderRequest+"',IsActiveEntity=true)/UploadFileContentBinary";var o=t.getObjectById("uploadReportRawDataDialog","fileUploaderRawData");var s=o.getFocusDomRef().files[0].name;var h=new sap.ui.unified.FileUploaderParameter();h.setName('Content-Type');h.setValue(t.getContentType(s));o.addHeaderParameter(h);var d=o.getModel().getHttpHeaders()["X-CSRF-Token"];var g=new sap.ui.unified.FileUploaderParameter();g.setName('x-csrf-token');g.setValue(d);o.addHeaderParameter(g);var i=new sap.ui.unified.FileUploaderParameter();i.setName('Content-Disposition');i.setValue('filename="'+encodeURIComponent(s)+'"');o.addHeaderParameter(i);o.setUploadUrl(f);o.upload();},onCreateSORFailed:function(E){var d=t.getObjectById("uploadReportRawDataDialog","dialogUploadFile");d.setBusy(false);var s=r.getText("fileUpldBiz_uploadFailed");if(typeof E.error==="object"){M.error(E.error.message?E.error.message:s);}else{try{var o=JSON.parse(E.responseText);}catch(c){M.error(s);return;}M.error(o.error&&o.error.message&&o.error.message.value?o.error.message.value:s);}},onUploadFailed:function(){var u=r.getText("fileUpldBiz_uploadFailed");var d=t.getObjectById("uploadReportRawDataDialog","dialogUploadFile");d.setBusy(false);M.error(u);},trimStr:function(v){if(!v){return null;}else{return v.trim();}}};}};return t;});
